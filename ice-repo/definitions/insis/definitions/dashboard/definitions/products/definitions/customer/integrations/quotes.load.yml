integration:
  exchange:
    InsisRestPQCallExchangeRule:
      endpointBaseurl: "insis-rest-endpoint"
      verb: post
      url: "/util/query/paginated-query"
  transformation:
    DefaultTransformationRule:
      out:
        - mappings:
            - param: queryId
              value: policies.client.get-detailed

            - param: p_client
              principal: pid
            - param: offset
              datastore: pagination.quotes.offset
            - param: page_size
              datastore: pagination.quotes.page-size
            - param: policy_id
              value: null
            - param: policy_no
              value: null
            - param: policy_name
              value: null
            - param: insr_type
              value: null
            - param: p_insured_object
              value: null
            - param: policy_state
              value: null
            - param: p_insr_end
              value: null

      in:
        - fromIdx:
            array: payload.rows
            condition: policy_state < -1
          toIdx:
            array: datamodel.quotes
            append: true
          mappings:
            - payload: "rows[n].engagement_id"
              element: quotes~engagement-id
            - payload: "rows[n].insured_objects"
              element: quotes~insured_objects
            - payload: "rows[n].policy_state"
              element: quotes~state
            - payload: "rows[n].policy_state_name"
              element: quotes~state-name
            - payload: "rows[n].product_name"
              element: quotes~product.name
            - payload: "rows[n].insr_type"
              element: quotes~product.code
            - payload: "rows[n].insr_begin"
              element: quotes~insurance.start
            - payload: "rows[n].insr_duration"
              element: quotes~insurance.duration
            - payload: "rows[n].insr_duration_unit"
              element: quotes~insurance.duration-unit
            - payload: "rows[n].policy_no"
              element: quotes~policy-number
            - payload: "rows[n].premium_amnt"
              element: quotes~price
            - payload: "rows[n].quote_id"
              element: quotes~id
            - value: quote.navigate-to-details
              element: quotes~continue
            - payload: "rows[n].total"
              datastore: pagination.quotes.results-length
        - fromIdx:
            array: payload.rows
            fromIdx:
              array: insured_objects
          toIdx:
            array: datamodel.quotes
            useSourceIndex: true
            toIdx:
              array: insured_objects
              useSourceIndex: true
          mappings:
            - payload: "rows[n].insured_objects[n].object_name"
              element: quotes~insured_objects~object_name
